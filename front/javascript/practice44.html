<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kakao Map (Async, Geolocation)</title>
    <style>
        /* 반응형 높이 예시: 필요에 맞게 조절 */
        #map {
            width: 100%;
            height: 420px;
        }
    </style>
</head>

<body>
    <h1>내 위치 표시 지도</h1>
    <div id="map"></div>

    <!-- Kakao Maps SDK: autoload=false 로 파서 차단 없이 로드 -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=626298ed16d825037d2cad43be2921e3&autoload=false" defer>
    </script>

    <script>
        // 페이지 로드가 끝나면 Kakao SDK 내부 리소스를 로드한 뒤 initMap 실행
        window.addEventListener('DOMContentLoaded', () => {
            kakao.maps.load(initMap);
        });

        function initMap() {
            const container = document.getElementById('map');

            // 초기 중심(임시): 서울 시청 좌표
            const initialPos = new kakao.maps.LatLng(37.5665, 126.9780);

            const map = new kakao.maps.Map(container, {
                center: initialPos,
                level: 4
            });

            // 공용 마커 아이콘(선택)
            const marker = new kakao.maps.Marker({ position: initialPos });
            marker.setMap(map);

            // 현재 위치 요청 (HTTPS 환경 또는 localhost 권장)
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;
                        const loc = new kakao.maps.LatLng(lat, lng);

                        // 마커 위치 갱신 + 지도 중심 이동
                        marker.setPosition(loc);
                        map.panTo(loc);

                        // 말풍선(선택)
                        const info = new kakao.maps.InfoWindow({
                            content: '<div style="padding:6px 10px">현재 위치</div>'
                        });
                        info.open(map, marker);
                    },
                    (err) => {
                        console.warn('geolocation 오류:', err);
                        // 실패 시: 초기 위치 그대로 사용 (필요하면 안내 메시지 표시)
                    },
                    { enableHighAccuracy: true, timeout: 8000, maximumAge: 30000 }
                );
            } else {
                console.warn('이 브라우저는 geolocation을 지원하지 않습니다.');
            }

            // 리사이즈 시 중심 보정(옵션)
            window.addEventListener('resize', () => {
                const center = map.getCenter();
                setTimeout(() => map.setCenter(center), 0);
            });
        }
    </script>
</body>

</html>